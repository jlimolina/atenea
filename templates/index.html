<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atenea - Asistente Multimodal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="logo">ðŸ¦‰</span> Atenea</h1>
            <p class="subtitle">Tu asistente multimodal de inteligencia artificial</p>
        </header>

        {% if error %}
            <div class="error-message"><strong>Error:</strong> {{ error }}</div>
        {% endif %}

        <div class="info-box">
            <span class="info-icon">ðŸ’¡</span>
            <span>Selecciona un modo, interactÃºa con los modelos o gestiona tu biblioteca de IA.</span>
        </div>

        <form id="main-form" action="{{ url_for('ask') }}" method="post">
            <div class="mode-selector">
                <label class="mode-option llm active" id="llm-option">
                    <input type="radio" name="mode" value="llm" checked hidden> Modelo de Lenguaje (LLM)
                </label>
                <label class="mode-option tts" id="tts-option">
                    <input type="radio" name="mode" value="tts" hidden> Texto a Voz (TTS)
                </label>
            </div>

            <div class="form-section" id="llm-section">
                <label for="model">Selecciona un modelo LLM instalado:</label>
                <select name="model" id="model" required>
                    {% if models %}
                        <option value="" disabled selected>-- Elige un modelo --</option>
                        {% for model_name in models %}<option value="{{ model_name }}">{{ model_name }}</option>{% endfor %}
                    {% else %}
                        <option value="" disabled selected>-- No hay modelos instalados --</option>
                    {% endif %}
                </select>
            </div>
            
            <div class="form-section" id="tts-engine-section">
                <label for="tts_engine">Motor de Voz:</label>
                <select name="tts_engine" id="tts_engine">
                    <option value="silero">Silero</option>
                    <option value="coqui">Coqui TTS (ClonaciÃ³n)</option>
                </select>
            </div>

            <div class="form-section" id="tts-speaker-section">
                <label for="tts_speaker">Voz / Locutor:</label>
                <select name="tts_speaker" id="tts_speaker" required>
                    </select>
            </div>

            <div class="form-section">
                <label for="question" id="question-label">Tu consulta:</label>
                <textarea name="question" id="question" minlength="3" required placeholder="Escribe tu texto aquÃ­..."></textarea>
            </div>

            <button type="submit" id="submit-btn">
                <span id="submit-text">Generar Respuesta</span>
                <span id="loading-indicator" style="display:none;">Procesando...</span>
            </button>
        </form>
        
        <div class="upload-section" style="margin-top: 30px; border-top: 1px solid #e9ecef; padding-top: 30px;">
            <h2>AÃ±adir una nueva voz para clonar</h2>
            <p>Sube un archivo <strong>.wav</strong> para usarlo como una nueva opciÃ³n en el motor Coqui TTS.</p>
            <form action="{{ url_for('upload_voice') }}" method="post" enctype="multipart/form-data">
                <input type="file" name="voice_file" accept=".wav" required>
                <button type="submit" style="width: auto; padding: 10px 15px; margin-top: 10px;">Subir Voz</button>
            </form>
        </div>
        
        <footer>
            Atenea AI v2.0 | Sistema Multimodal LLM + TTS | 
            <a href="{{ url_for('manage_page') }}">Gestionar Modelos</a>
        </footer>
    </div>

    <script>
        const llmSection = document.getElementById('llm-section');
        const ttsEngineSection = document.getElementById('tts-engine-section');
        const ttsSpeakerSection = document.getElementById('tts-speaker-section');
        
        const llmModelSelect = document.getElementById('model');
        const ttsEngineSelect = document.getElementById('tts_engine');
        const ttsSpeakerSelect = document.getElementById('tts_speaker');

        const voicesByEngine = {
            'silero': {
                'Voz Femenina 1': 'es_0',
                'Voz Femenina 2': 'es_1',
                'Voz Femenina 3': 'es_2',
            },
            'coqui': {
                {% for voice_file in available_voices %}
                    '{{ voice_file.split(".")[0].replace("_", " ")|title }}': 'voices/{{ voice_file }}',
                {% endfor %}
            }
        };

        function updateSpeakerOptions() {
            const selectedEngine = ttsEngineSelect.value;
            ttsSpeakerSelect.innerHTML = ''; 
            const availableVoices = voicesByEngine[selectedEngine];
            for (const name in availableVoices) {
                const value = availableVoices[name];
                ttsSpeakerSelect.add(new Option(name, value));
            }
        }

        function updateFormMode() {
            const isTTSMode = document.querySelector('input[name="mode"]:checked').value === 'tts';
            llmSection.style.display = isTTSMode ? 'none' : 'block';
            ttsEngineSection.style.display = isTTSMode ? 'block' : 'none';
            ttsSpeakerSection.style.display = isTTSMode ? 'block' : 'none';
            llmModelSelect.disabled = isTTSMode;
            ttsEngineSelect.disabled = !isTTSMode;
            ttsSpeakerSelect.disabled = !isTTSMode;
            
            document.getElementById('llm-option').classList.toggle('active', !isTTSMode);
            document.getElementById('tts-option').classList.toggle('active', isTTSMode);
            document.getElementById('question-label').textContent = isTTSMode ? 'Texto a convertir a voz:' : 'Tu consulta:';
            document.getElementById('submit-text').textContent = isTTSMode ? 'Generar Audio' : 'Generar Respuesta';
        }
        
        document.getElementById('main-form').addEventListener('submit', function() {
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.querySelector('#submit-text').style.display = 'none';
            submitBtn.querySelector('#loading-indicator').style.display = 'inline';
        });

        document.getElementById('llm-option').addEventListener('click', () => {
             document.querySelector('input[name="mode"][value="llm"]').checked = true;
             updateFormMode();
        });
        
        document.getElementById('tts-option').addEventListener('click', () => {
             document.querySelector('input[name="mode"][value="tts"]').checked = true;
             updateFormMode();
        });
        
        ttsEngineSelect.addEventListener('change', updateSpeakerOptions);

        updateFormMode();
        updateSpeakerOptions();
    </script>
</body>
</html>
